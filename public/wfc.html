<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LZ</title>
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type= "text/css" href="./styles.css"><link rel="icon"
       href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘»</text></svg>"><header>
| <a href="./">home</a>
| <a href="#top">top</a>
|  <a href="https://github.com/larzeitlin">github</a>
| ðŸ‘»
</header>
</head>
<body>
<div id="content" class="content">
<h1 class="title">LZ</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org3d79394">WaveFunctionCollapse</a></li>
<li><a href="#org0224250">Setup</a>
<ul>
<li><a href="#orge5e31a9">Tiles</a></li>
<li><a href="#orgb426984">Drawing a grid of tiles</a>
<ul>
<li><a href="#orgca0cfd1">Pick out some tiles to use</a></li>
</ul>
</li>
<li><a href="#org4f6dc83">A random world</a></li>
</ul>
</li>
<li><a href="#orgddcd02b">Adjacency rules</a></li>
<li><a href="#orge1a9ecd">Applying the rules</a>
<ul>
<li><a href="#org5d7a90e">displaying it</a></li>
</ul>
</li>
<li><a href="#orgd24ef25">What next</a></li>
</ul>
</div>
</div>
    <script src="https://cdn.jsdelivr.net/npm/scittle@0.6.15/dist/scittle.js" type="application/javascript"></script>
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/scittle@0.6.15/dist/scittle.reagent.js" type="application/javascript"></script>
<script src="code/wfc.cljs" type="application/x-scittle"></script>

  <body>
    <div id="app"></div>
  </body>

<div id="outline-container-org3d79394" class="outline-2">
<h2 id="org3d79394">WaveFunctionCollapse</h2>
<div class="outline-text-2" id="text-org3d79394">
<p>
WaveFunctionCollapse is a texture synthesis algorithm. It can be used to procedurally creating maps out of tile-sets based on adjacency rules. This post expounds a simplified version of it in CLJS. Let's make some RPG world maps using it.
</p>
</div>
</div>

<div id="outline-container-org0224250" class="outline-2">
<h2 id="org0224250">Setup</h2>
<div class="outline-text-2" id="text-org0224250">
</div>
<div id="outline-container-orge5e31a9" class="outline-3">
<h3 id="orge5e31a9">Tiles</h3>
<div class="outline-text-3" id="text-orge5e31a9">
<p>
Firstly I grabbed a free tile-set from <a href="https://opengameart.org/content/16x16-overworld-tiles">opengamechart.org</a>. They came as a single gif file so I converted it to a png and then had chatGPT write a script to split it into the 16x16 pixel tiles.
</p>
</div>
</div>

<div id="outline-container-orgb426984" class="outline-3">
<h3 id="orgb426984">Drawing a grid of tiles</h3>
<div class="outline-text-3" id="text-orgb426984">
<p>
Let's do some setup to show a css grid of tiles:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #ffffff;">(</span>require '<span style="color: #ff62d4;">[</span>reagent.core <span style="color: #00bcff;">:as</span> r<span style="color: #ff62d4;">]</span>
         '<span style="color: #ff62d4;">[</span>reagent.dom <span style="color: #00bcff;">:as</span> rdom<span style="color: #ff62d4;">]</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">tile-grid</span> <span style="color: #ff62d4;">[</span><span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:keys</span> <span style="color: #fba849;">[</span>tile-width-px n-columns<span style="color: #fba849;">]</span><span style="color: #3fdfd0;">}</span>
                tiles<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #3fdfd0;">[</span>style <span style="color: #fba849;">{</span><span style="color: #00bcff;">:display</span> <span style="color: #79a8ff;">"grid"</span>
               <span style="color: #00bcff;">:width</span> <span style="color: #9f80ff;">(</span>str <span style="color: #4fe42f;">(</span>* tile-width-px n-columns<span style="color: #4fe42f;">)</span> <span style="color: #79a8ff;">"px"</span><span style="color: #9f80ff;">)</span>
               <span style="color: #00bcff;">:grid-template-columns</span> <span style="color: #9f80ff;">(</span>str <span style="color: #79a8ff;">"repeat(auto-fill, "</span>
                                           tile-width-px
                                           <span style="color: #79a8ff;">"px)"</span><span style="color: #9f80ff;">)</span><span style="color: #fba849;">}</span><span style="color: #3fdfd0;">]</span>
    <span style="color: #3fdfd0;">(</span>into <span style="color: #fba849;">[</span><span style="color: #00bcff;">:div</span> <span style="color: #9f80ff;">{</span><span style="color: #00bcff;">:style</span> style<span style="color: #9f80ff;">}</span><span style="color: #fba849;">]</span> tiles<span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">tile-img</span> <span style="color: #ff62d4;">[</span><span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:keys</span> <span style="color: #fba849;">[</span>tile-img-path
                        width-px<span style="color: #fba849;">]</span><span style="color: #3fdfd0;">}</span><span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">[</span><span style="color: #00bcff;">:img</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:src</span> tile-img-path
         <span style="color: #00bcff;">:style</span> <span style="color: #fba849;">{</span><span style="color: #00bcff;">:width</span> <span style="color: #9f80ff;">(</span>str width-px <span style="color: #79a8ff;">"px"</span><span style="color: #9f80ff;">)</span>
                 <span style="color: #00bcff;">:height</span> <span style="color: #9f80ff;">(</span>str width-px <span style="color: #79a8ff;">"px"</span><span style="color: #9f80ff;">)</span>
                 <span style="color: #00bcff;">:max-width</span> <span style="color: #79a8ff;">"100%"</span><span style="color: #fba849;">}</span><span style="color: #3fdfd0;">}</span><span style="color: #ff62d4;">]</span><span style="color: #ffffff;">)</span>
</pre>
</div>
</div>

<div id="outline-container-orgca0cfd1" class="outline-4">
<h4 id="orgca0cfd1">Pick out some tiles to use</h4>
<div class="outline-text-4" id="text-orgca0cfd1">
<p>
I went through the tiles and picked out some water, coast and grassland tiles to start with. Let's generate a map from these:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">def</span> <span style="color: #00d3d0;">tile-dir</span> <span style="color: #79a8ff;">"assets/tiles/"</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">def</span> <span style="color: #00d3d0;">tile-paths</span>
  <span style="color: #ff62d4;">{</span><span style="color: #00bcff;">:water</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_10_1.png"</span><span style="color: #3fdfd0;">)</span>
   <span style="color: #00bcff;">:grass</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_6_13.png"</span><span style="color: #3fdfd0;">)</span>
   <span style="color: #00bcff;">:grass-coast-w</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_9_1.png"</span><span style="color: #3fdfd0;">)</span>
   <span style="color: #00bcff;">:grass-coast-sw</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_9_2.png"</span><span style="color: #3fdfd0;">)</span>
   <span style="color: #00bcff;">:grass-coast-s</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_10_2.png"</span><span style="color: #3fdfd0;">)</span>
   <span style="color: #00bcff;">:grass-coast-e</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_11_1.png"</span><span style="color: #3fdfd0;">)</span>
   <span style="color: #00bcff;">:grass-coast-se</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_11_2.png"</span><span style="color: #3fdfd0;">)</span>
   <span style="color: #00bcff;">:grass-coast-ne</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_11_0.png"</span><span style="color: #3fdfd0;">)</span>
   <span style="color: #00bcff;">:grass-coast-n</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_10_0.png"</span><span style="color: #3fdfd0;">)</span>
   <span style="color: #00bcff;">:grass-coast-nw</span> <span style="color: #3fdfd0;">(</span>str tile-dir <span style="color: #79a8ff;">"tile_9_0.png"</span><span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">}</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">random-tile</span> <span style="color: #ff62d4;">[]</span>
  <span style="color: #ff62d4;">[</span>tile-img
   <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:tile-img-path</span> <span style="color: #fba849;">(</span><span style="color: #b6a0ff;">-&gt;</span> tile-paths vals rand-nth<span style="color: #fba849;">)</span>
    <span style="color: #00bcff;">:width-px</span> 16<span style="color: #3fdfd0;">}</span><span style="color: #ff62d4;">]</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">world</span> <span style="color: #ff62d4;">[]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #3fdfd0;">[</span>tiles <span style="color: #fba849;">(</span>take 25 <span style="color: #9f80ff;">(</span>repeatedly random-tile<span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">]</span>
    <span style="color: #3fdfd0;">[</span>tile-grid
     <span style="color: #fba849;">{</span><span style="color: #00bcff;">:tile-width-px</span> 16
      <span style="color: #00bcff;">:n-columns</span> 5<span style="color: #fba849;">}</span>
     tiles<span style="color: #3fdfd0;">]</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #6ae4b9;">rdom</span>/render
 <span style="color: #ff62d4;">[</span>world<span style="color: #ff62d4;">]</span>
 <span style="color: #ff62d4;">(</span>.getElementById <span style="color: #6ae4b9;">js</span>/document <span style="color: #79a8ff;">"random-world"</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4f6dc83" class="outline-3">
<h3 id="org4f6dc83">A random world</h3>
<div class="outline-text-3" id="text-org4f6dc83">
<p>
Here is a random 5x5 world. It will change if you refresh the page. We can see that there are no adjacency rules here so the map doesn't really make sense. 
</p>
<body>
  <div id="random-world"></div>
</body>
</div>
</div>
</div>


<div id="outline-container-orgddcd02b" class="outline-2">
<h2 id="orgddcd02b">Adjacency rules</h2>
<div class="outline-text-2" id="text-orgddcd02b">
<p>
We need a set of rules to see which tiles are allowed to go next to which. This can become quite painstaking if you do it by hand. The original WFC project has a tool to analyse existing valid maps and extract rules from them. Here we only have a few tiles and I don't have any example maps, so I've used a "sockets" approach whereby we match up tile types based on the content at positions on the corresponding edges of the tiles.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">def</span> <span style="color: #00d3d0;">all-tile-edges</span>
  <span style="color: #ff62d4;">{</span><span style="color: #00bcff;">:water</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:water</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:grass</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-n</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:grass</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-e</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:water</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-s</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:water</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-w</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:grass</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-ne-corner</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:water</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-nw-corner</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:grass</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-se-corner</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:water</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-sw-corner</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:water</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-n+e</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:grass</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-n+w</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:grass</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-s+e</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:water</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:grass-coast-s+w</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:water</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:grass</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:grass</span><span style="color: #3fdfd0;">}</span><span style="color: #ff62d4;">}</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">def</span> <span style="color: #00d3d0;">edge-&gt;sockets</span>
  <span style="color: #ff62d4;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:se</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:s</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:ne</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:e</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:nw</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:w</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:ne</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:ne</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:sw</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:sw</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:ne</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:nw</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:se</span><span style="color: #3fdfd0;">}</span>
   <span style="color: #00bcff;">:se</span> <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:nw</span><span style="color: #3fdfd0;">}</span><span style="color: #ff62d4;">}</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">def</span> <span style="color: #00d3d0;">invert-direction</span>
  <span style="color: #ff62d4;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #00bcff;">:s</span>
   <span style="color: #00bcff;">:s</span> <span style="color: #00bcff;">:n</span>
   <span style="color: #00bcff;">:e</span> <span style="color: #00bcff;">:w</span>
   <span style="color: #00bcff;">:w</span> <span style="color: #00bcff;">:e</span>
   <span style="color: #00bcff;">:ne</span> <span style="color: #00bcff;">:sw</span>
   <span style="color: #00bcff;">:sw</span> <span style="color: #00bcff;">:ne</span>
   <span style="color: #00bcff;">:se</span> <span style="color: #00bcff;">:nw</span>
   <span style="color: #00bcff;">:nw</span> <span style="color: #00bcff;">:se</span><span style="color: #ff62d4;">}</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">adjacent-tile-valid-sockets</span> <span style="color: #ff62d4;">[</span>input-tile-edges edge<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #3fdfd0;">[</span>required-sockets <span style="color: #fba849;">(</span>edge-&gt;sockets edge<span style="color: #fba849;">)</span><span style="color: #3fdfd0;">]</span>
    <span style="color: #3fdfd0;">(</span><span style="color: #b6a0ff;">-&gt;&gt;</span>
     <span style="color: #fba849;">(</span><span style="color: #b6a0ff;">for</span> <span style="color: #9f80ff;">[</span><span style="color: #4fe42f;">[</span>from-edge to-edge<span style="color: #4fe42f;">]</span> required-sockets<span style="color: #9f80ff;">]</span>
       <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #4fe42f;">[</span>tile-edge-type <span style="color: #fe6060;">(</span>from-edge input-tile-edges<span style="color: #fe6060;">)</span><span style="color: #4fe42f;">]</span>
         <span style="color: #4fe42f;">[</span>to-edge tile-edge-type<span style="color: #4fe42f;">]</span><span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span>
     <span style="color: #fba849;">(</span>into <span style="color: #9f80ff;">{}</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">valid-tiles</span> <span style="color: #ff62d4;">[</span>valid-sockets tile-edges<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">-&gt;&gt;</span> tile-edges
       <span style="color: #3fdfd0;">(</span>filter
        <span style="color: #fba849;">(</span><span style="color: #b6a0ff;">fn</span> <span style="color: #9f80ff;">[</span><span style="color: #4fe42f;">[</span>_ edges<span style="color: #4fe42f;">]</span><span style="color: #9f80ff;">]</span>
          <span style="color: #9f80ff;">(</span><span style="color: #6ae4b9;">set</span>/subset? <span style="color: #4fe42f;">(</span>set valid-sockets<span style="color: #4fe42f;">)</span>
                       <span style="color: #4fe42f;">(</span>set edges<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">)</span>
       <span style="color: #3fdfd0;">(</span>map first<span style="color: #3fdfd0;">)</span>
       set<span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">def</span> <span style="color: #00d3d0;">all-tile-types</span> <span style="color: #ff62d4;">(</span>keys tile-paths<span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge1a9ecd" class="outline-2">
<h2 id="orge1a9ecd">Applying the rules</h2>
<div class="outline-text-2" id="text-orge1a9ecd">
<p>
Each cell will start with a complete set of possible tile types. For each iteration we will resolve one of the tiles with the lowest number of possible types. Then we need to update its neighbours since it will have an impact on what values are still possible for the neighbours.
</p>

<p>
Sometimes a tile will resolve automatically by only having one tile type left. This is fine, but it means we just need to re-check the neighbours of the tile we are about to resolve to see if any of its neighbours have been automatically resolved.
</p>

<p>
All of the below has been written with a flagrant disregard for performance.
</p>

<div class="org-src-container">
<pre class="src src-clojure">
<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">init-grid</span> <span style="color: #ff62d4;">[</span>width<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span>vec
   <span style="color: #3fdfd0;">(</span>take <span style="color: #fba849;">(</span>* width width<span style="color: #fba849;">)</span>
         <span style="color: #fba849;">(</span>repeat <span style="color: #9f80ff;">(</span>set all-tile-types<span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">find-lowest-entropy-idx</span> <span style="color: #ff62d4;">[</span>grid<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">some-&gt;&gt;</span> grid
           <span style="color: #3fdfd0;">(</span>map-indexed <span style="color: #fba849;">(</span><span style="color: #b6a0ff;">fn</span> <span style="color: #9f80ff;">[</span>idx poss-vals<span style="color: #9f80ff;">]</span>
                          <span style="color: #9f80ff;">[</span>idx <span style="color: #4fe42f;">(</span>count poss-vals<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">]</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">)</span>
           shuffle
           <span style="color: #3fdfd0;">(</span>sort-by second<span style="color: #3fdfd0;">)</span>
           <span style="color: #3fdfd0;">(</span>drop-while #<span style="color: #fba849;">(</span>&lt; <span style="color: #9f80ff;">(</span>second <span style="color: #00d3d0;">%</span><span style="color: #9f80ff;">)</span> 2<span style="color: #fba849;">)</span><span style="color: #3fdfd0;">)</span>
           first
           first<span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">find-neighbours</span> <span style="color: #ff62d4;">[</span>grid-width idx<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #3fdfd0;">[</span>first-row? <span style="color: #fba849;">(</span>&lt; idx grid-width<span style="color: #fba849;">)</span>
        first-in-row? <span style="color: #fba849;">(</span>zero? <span style="color: #9f80ff;">(</span>mod idx grid-width<span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span>
        last-in-row? <span style="color: #fba849;">(</span>= <span style="color: #9f80ff;">(</span>dec grid-width<span style="color: #9f80ff;">)</span>
                        <span style="color: #9f80ff;">(</span>mod idx grid-width<span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span>
        last-row? <span style="color: #fba849;">(</span>&gt;= idx <span style="color: #9f80ff;">(</span>* grid-width
                             <span style="color: #4fe42f;">(</span>dec grid-width<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">]</span>
    <span style="color: #3fdfd0;">(</span><span style="color: #b6a0ff;">-&gt;&gt;</span>
     <span style="color: #fba849;">{</span><span style="color: #00bcff;">:n</span> <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">when-not</span> first-row?
           <span style="color: #4fe42f;">(</span>- idx grid-width<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span>
      <span style="color: #00bcff;">:ne</span> <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">when-not</span>
           <span style="color: #4fe42f;">(</span><span style="color: #b6a0ff;">or</span> first-row? last-in-row?<span style="color: #4fe42f;">)</span>
            <span style="color: #4fe42f;">(</span>- idx <span style="color: #fe6060;">(</span>dec grid-width<span style="color: #fe6060;">)</span><span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span>
      <span style="color: #00bcff;">:e</span> <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">when-not</span> last-in-row? <span style="color: #4fe42f;">(</span>inc idx<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span>
      <span style="color: #00bcff;">:se</span> <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">when-not</span> <span style="color: #4fe42f;">(</span><span style="color: #b6a0ff;">or</span> last-in-row? last-row?<span style="color: #4fe42f;">)</span>
            <span style="color: #4fe42f;">(</span>+ idx grid-width 1<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span>
      <span style="color: #00bcff;">:s</span> <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">when-not</span> last-row?
           <span style="color: #4fe42f;">(</span>+ idx grid-width<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span>
      <span style="color: #00bcff;">:sw</span> <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">when-not</span> <span style="color: #4fe42f;">(</span><span style="color: #b6a0ff;">or</span> first-in-row? last-row?<span style="color: #4fe42f;">)</span>
            <span style="color: #4fe42f;">(</span>+ idx grid-width -1<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span>
      <span style="color: #00bcff;">:w</span> <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">when-not</span> first-in-row?
           <span style="color: #4fe42f;">(</span>dec idx<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span>
      <span style="color: #00bcff;">:nw</span> <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">when-not</span> <span style="color: #4fe42f;">(</span><span style="color: #b6a0ff;">or</span> first-row? first-in-row?<span style="color: #4fe42f;">)</span>
            <span style="color: #4fe42f;">(</span>- idx <span style="color: #fe6060;">(</span>inc grid-width<span style="color: #fe6060;">)</span><span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span><span style="color: #fba849;">}</span>
     <span style="color: #fba849;">(</span>filter val<span style="color: #fba849;">)</span>
     <span style="color: #fba849;">(</span>into <span style="color: #9f80ff;">{}</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">remaining-possibilities</span>
  <span style="color: #ff62d4;">[</span>grid-width grid idx<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #3fdfd0;">[</span>neighbours <span style="color: #fba849;">(</span>find-neighbours grid-width idx<span style="color: #fba849;">)</span>
        prev-possibilities <span style="color: #fba849;">(</span>nth grid idx<span style="color: #fba849;">)</span>
        possibilities-from-resolved-neighbours
        <span style="color: #fba849;">(</span><span style="color: #b6a0ff;">-&gt;&gt;</span>
         <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">for</span> <span style="color: #4fe42f;">[</span><span style="color: #fe6060;">[</span>direction nei-idx<span style="color: #fe6060;">]</span> neighbours
               <span style="color: #00bcff;">:let</span> <span style="color: #fe6060;">[</span>nei <span style="color: #4fafff;">(</span>nth grid nei-idx<span style="color: #4fafff;">)</span><span style="color: #fe6060;">]</span>
               <span style="color: #00bcff;">:when</span> <span style="color: #fe6060;">(</span>= <span style="color: #4fafff;">(</span>count nei<span style="color: #4fafff;">)</span> 1<span style="color: #fe6060;">)</span>
               <span style="color: #00bcff;">:let</span> <span style="color: #fe6060;">[</span>nei-type <span style="color: #4fafff;">(</span><span style="color: #b6a0ff;">-&gt;</span> nei vec first<span style="color: #4fafff;">)</span>
                     nei-tile-edges <span style="color: #4fafff;">(</span>all-tile-edges nei-type<span style="color: #4fafff;">)</span>
                     valid-sockets <span style="color: #4fafff;">(</span>adjacent-tile-valid-sockets
                                    nei-tile-edges
                                    <span style="color: #f0dd60;">(</span>invert-direction direction<span style="color: #f0dd60;">)</span><span style="color: #4fafff;">)</span><span style="color: #fe6060;">]</span><span style="color: #4fe42f;">]</span>
           <span style="color: #4fe42f;">(</span>valid-tiles valid-sockets all-tile-edges<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span>
         <span style="color: #9f80ff;">(</span>apply <span style="color: #6ae4b9;">set</span>/intersection<span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">]</span>
    <span style="color: #3fdfd0;">(</span><span style="color: #b6a0ff;">or</span> possibilities-from-resolved-neighbours
        prev-possibilities<span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">update-cell-reducer-fn</span> <span style="color: #ff62d4;">[</span>grid-width<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">fn</span> <span style="color: #3fdfd0;">[</span>grid idx<span style="color: #3fdfd0;">]</span>
    <span style="color: #3fdfd0;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #fba849;">[</span>prev-types <span style="color: #9f80ff;">(</span>nth grid idx<span style="color: #9f80ff;">)</span><span style="color: #fba849;">]</span>
      <span style="color: #fba849;">(</span><span style="color: #b6a0ff;">if</span> <span style="color: #9f80ff;">(</span>= 1 <span style="color: #4fe42f;">(</span>count prev-types<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span>
        grid
        <span style="color: #9f80ff;">(</span>assoc grid idx
               <span style="color: #4fe42f;">(</span>remaining-possibilities grid-width grid idx<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">update-neighbours</span> <span style="color: #ff62d4;">[</span>grid grid-width idx<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #3fdfd0;">[</span>neighbours <span style="color: #fba849;">(</span>find-neighbours grid-width idx<span style="color: #fba849;">)</span><span style="color: #3fdfd0;">]</span>
    <span style="color: #3fdfd0;">(</span>reduce <span style="color: #fba849;">(</span>update-cell-reducer-fn grid-width<span style="color: #fba849;">)</span>
            grid
            <span style="color: #fba849;">(</span>vals neighbours<span style="color: #fba849;">)</span><span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">resolve-tile</span> <span style="color: #ff62d4;">[</span>possible-values<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">-&gt;&gt;</span> possible-values
       vec
       shuffle
       <span style="color: #3fdfd0;">(</span>take 1<span style="color: #3fdfd0;">)</span>
       set<span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">iterate-grid</span> <span style="color: #ff62d4;">[</span>grid-width <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:keys</span> <span style="color: #fba849;">[</span>grid finished?<span style="color: #fba849;">]</span><span style="color: #3fdfd0;">}</span><span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #3fdfd0;">[</span>lowest-entropy-idx <span style="color: #fba849;">(</span>find-lowest-entropy-idx grid<span style="color: #fba849;">)</span><span style="color: #3fdfd0;">]</span>
    <span style="color: #3fdfd0;">(</span><span style="color: #b6a0ff;">if</span> <span style="color: #fba849;">(</span><span style="color: #b6a0ff;">or</span> finished? <span style="color: #9f80ff;">(</span>not lowest-entropy-idx<span style="color: #9f80ff;">)</span><span style="color: #fba849;">)</span>
      <span style="color: #fba849;">{</span><span style="color: #00bcff;">:finished?</span> <span style="color: #00bcff;">true</span>
       <span style="color: #00bcff;">:grid</span> grid<span style="color: #fba849;">}</span>
      <span style="color: #fba849;">{</span><span style="color: #00bcff;">:finished?</span> <span style="color: #00bcff;">false</span>
       <span style="color: #00bcff;">:grid</span> <span style="color: #9f80ff;">(</span><span style="color: #b6a0ff;">-&gt;</span> grid
                 <span style="color: #4fe42f;">(</span>assoc lowest-entropy-idx
                        <span style="color: #fe6060;">(</span>resolve-tile
                         <span style="color: #4fafff;">(</span>remaining-possibilities grid-width
                                                  grid
                                                  lowest-entropy-idx<span style="color: #4fafff;">)</span><span style="color: #fe6060;">)</span><span style="color: #4fe42f;">)</span>
                 <span style="color: #4fe42f;">(</span>update-neighbours grid-width lowest-entropy-idx<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">)</span><span style="color: #fba849;">}</span><span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span> 
</pre>
</div>
</div>

<div id="outline-container-org5d7a90e" class="outline-3">
<h3 id="org5d7a90e">displaying it</h3>
<div class="outline-text-3" id="text-org5d7a90e">
<p>
Here's the plumbing used to render it here.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">wfc-grid</span> <span style="color: #ff62d4;">[</span>n-columns grid<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">[</span>tile-grid <span style="color: #3fdfd0;">{</span><span style="color: #00bcff;">:tile-width-px</span> 16
              <span style="color: #00bcff;">:n-columns</span> n-columns<span style="color: #3fdfd0;">}</span>
   <span style="color: #3fdfd0;">(</span>map-indexed
    <span style="color: #fba849;">(</span><span style="color: #b6a0ff;">fn</span> <span style="color: #9f80ff;">[</span>idx cell-possible-values<span style="color: #9f80ff;">]</span>
      <span style="color: #9f80ff;">[</span>tile-img
       <span style="color: #4fe42f;">{</span><span style="color: #00bcff;">:idx</span> idx
        <span style="color: #00bcff;">:tile-img-path</span>
        <span style="color: #fe6060;">(</span><span style="color: #b6a0ff;">if</span> <span style="color: #4fafff;">(</span>= <span style="color: #f0dd60;">(</span>count cell-possible-values<span style="color: #f0dd60;">)</span> 1<span style="color: #4fafff;">)</span>
          <span style="color: #4fafff;">(</span>tile-paths <span style="color: #f0dd60;">(</span><span style="color: #b6a0ff;">-&gt;</span> cell-possible-values vec first<span style="color: #f0dd60;">)</span><span style="color: #4fafff;">)</span>
          empty-tile<span style="color: #fe6060;">)</span>
        <span style="color: #00bcff;">:width-px</span> 16<span style="color: #4fe42f;">}</span><span style="color: #9f80ff;">]</span><span style="color: #fba849;">)</span>
    grid<span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">]</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #b6a0ff;">defn</span> <span style="color: #feacd0;">interactive-map</span> <span style="color: #ff62d4;">[</span>n-columns<span style="color: #ff62d4;">]</span>
  <span style="color: #ff62d4;">(</span><span style="color: #b6a0ff;">let</span> <span style="color: #3fdfd0;">[</span>state <span style="color: #fba849;">(</span><span style="color: #6ae4b9;">r</span>/atom <span style="color: #9f80ff;">{</span><span style="color: #00bcff;">:grid</span> <span style="color: #4fe42f;">(</span>init-grid n-columns<span style="color: #4fe42f;">)</span>
                       <span style="color: #00bcff;">:finished?</span> <span style="color: #00bcff;">false</span><span style="color: #9f80ff;">}</span><span style="color: #fba849;">)</span><span style="color: #3fdfd0;">]</span>
    <span style="color: #3fdfd0;">(</span><span style="color: #b6a0ff;">fn</span> <span style="color: #fba849;">[</span>_<span style="color: #fba849;">]</span>
      <span style="color: #fba849;">[</span><span style="color: #00bcff;">:div</span>
       <span style="color: #9f80ff;">[</span>wfc-grid n-columns <span style="color: #4fe42f;">(</span><span style="color: #00bcff;">:grid</span> @state<span style="color: #4fe42f;">)</span><span style="color: #9f80ff;">]</span>
       <span style="color: #9f80ff;">[</span><span style="color: #00bcff;">:div</span> <span style="color: #4fe42f;">{</span><span style="color: #00bcff;">:style</span> <span style="color: #fe6060;">{</span><span style="color: #00bcff;">:display</span> <span style="color: #79a8ff;">"flex"</span><span style="color: #fe6060;">}</span><span style="color: #4fe42f;">}</span>
        <span style="color: #4fe42f;">[</span><span style="color: #00bcff;">:p</span> <span style="color: #fe6060;">[</span><span style="color: #00bcff;">:button</span>
             <span style="color: #4fafff;">{</span><span style="color: #00bcff;">:on-click</span> #<span style="color: #f0dd60;">(</span>swap! state
                                <span style="color: #ffffff;">(</span>partial iterate-grid n-columns<span style="color: #ffffff;">)</span><span style="color: #f0dd60;">)</span><span style="color: #4fafff;">}</span>
             <span style="color: #79a8ff;">"iterate"</span><span style="color: #fe6060;">]</span><span style="color: #4fe42f;">]</span>
        <span style="color: #4fe42f;">[</span><span style="color: #00bcff;">:p</span> <span style="color: #fe6060;">[</span><span style="color: #00bcff;">:button</span>
             <span style="color: #4fafff;">{</span><span style="color: #00bcff;">:on-click</span> #<span style="color: #f0dd60;">(</span><span style="color: #b6a0ff;">while</span> <span style="color: #ffffff;">(</span>not <span style="color: #ff62d4;">(</span><span style="color: #00bcff;">:finished?</span> @state<span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>
                           <span style="color: #ffffff;">(</span>swap! state
                                  <span style="color: #ff62d4;">(</span>partial iterate-grid n-columns<span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span><span style="color: #f0dd60;">)</span><span style="color: #4fafff;">}</span>
             <span style="color: #79a8ff;">"finish"</span><span style="color: #fe6060;">]</span><span style="color: #4fe42f;">]</span>
        <span style="color: #4fe42f;">[</span><span style="color: #00bcff;">:p</span> <span style="color: #fe6060;">[</span><span style="color: #00bcff;">:button</span>
             <span style="color: #4fafff;">{</span><span style="color: #00bcff;">:on-click</span> #<span style="color: #f0dd60;">(</span>reset! state
                                 <span style="color: #ffffff;">{</span><span style="color: #00bcff;">:grid</span> <span style="color: #ff62d4;">(</span>init-grid n-columns<span style="color: #ff62d4;">)</span>
                                  <span style="color: #00bcff;">:finished?</span> <span style="color: #00bcff;">false</span><span style="color: #ffffff;">}</span><span style="color: #f0dd60;">)</span><span style="color: #4fafff;">}</span>
             <span style="color: #79a8ff;">"reset"</span><span style="color: #fe6060;">]</span><span style="color: #4fe42f;">]</span><span style="color: #9f80ff;">]</span><span style="color: #fba849;">]</span><span style="color: #3fdfd0;">)</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

<span style="color: #ffffff;">(</span><span style="color: #6ae4b9;">rdom</span>/render
 <span style="color: #ff62d4;">[</span>interactive-map 20<span style="color: #ff62d4;">]</span>
 <span style="color: #ff62d4;">(</span>.getElementById <span style="color: #6ae4b9;">js</span>/document <span style="color: #79a8ff;">"interactive-map"</span><span style="color: #ff62d4;">)</span><span style="color: #ffffff;">)</span>

</pre>
</div>

<body>
  <div id="interactive-map"></div>
</body>
</div>
</div>
</div>

<div id="outline-container-orgd24ef25" class="outline-2">
<h2 id="orgd24ef25">What next</h2>
<div class="outline-text-2" id="text-orgd24ef25">
<p>
The above would be improved by having weightings for the tile types, maybe making land tiles more likely. Adding more different tiles would also be fun.
</p>
</div>
</div>
</div>
</body>
</html>
